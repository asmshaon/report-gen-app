<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Manager | Stock Report Service</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="../public/css/styles.css">
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5">Report Manager</h1>
        <div x-data="reportGenerator()">
            <div class="d-flex align-items-center gap-2">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text bg-white"><i class="text-muted">ðŸ“„</i> &nbsp; Select Type:</span>
                    </div>
                    <select x-model="reportType" class="form-control form-control-lg custom-select" style="min-width: 180px; cursor: pointer;">
                        <option value="all">All Reports</option>
                        <option value="html">HTML Report</option>
                        <option value="pdf">PDF Report</option>
                        <option value="flipbook">Flipbook Report</option>
                    </select>
                </div>
                <button @click="generateReport" :disabled="generating" class="btn btn-success btn-lg shadow-sm px-4 report-get-btn" x-text="generating ? 'Generating...' : 'ðŸš€ Generate Report'"></button>
            </div>
            <div x-show="resultMessage" x-transition class="alert mt-2" :class="resultSuccess ? 'alert-success' : 'alert-danger'" x-html="resultMessage"></div>
        </div>
    </div>

    <div class="card mb-5" x-data="formManager()">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0" x-text="editingId ? 'Edit Report Settings' : 'Create Report Settings'"></h5>
            <button class="btn btn-sm btn-light" x-show="editingId" @click="resetForm()">Cancel Edit</button>
        </div>
        <div class="card-body">
            <form @submit.prevent="saveForm" enctype="multipart/form-data">
                <input type="hidden" name="id" x-model="formData.id">

                <h6 class="section-header">Basic Information</h6>
                <div class="row">
                    <div class="col-md-4 form-group">
                        <label>Report File Name</label>
                        <input type="text" name="file_name" x-model="formData.file_name" class="form-control" placeholder="6AIStocks" required>
                        <small class="text-muted">Used for output URL (e.g. 6AIStocks.html)</small>
                    </div>
                    <div class="col-md-5 form-group">
                        <label>Report Title</label>
                        <input type="text" name="report_title" x-model="formData.report_title" class="form-control" placeholder="Today's Top 6 AI Stocks" required>
                    </div>
                    <div class="col-md-3 form-group">
                        <label>Author Name</label>
                        <input type="text" name="author_name" x-model="formData.author_name" class="form-control" placeholder="Today's Top Stocks">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 form-group">
                        <label>Number of Stocks</label>
                        <input type="number" name="stock_count" x-model="formData.stock_count" class="form-control" value="6" min="1">
                    </div>
                    <div class="col-md-3 form-group">
                        <label>Data Source</label>
                        <input type="text" name="data_source" x-model="formData.data_source" class="form-control" value="data.csv" readonly>
                    </div>
                    <div class="col-md-3 form-group">
                        <label>Article Image (180x180)</label>
                        <input type="file" name="article_image" class="form-control-file" accept="image/png, image/jpeg, image/jpg, image/gif, image/webp" @change="validateArticleImage($event)">
                        <small x-show="formData.images.article_image" class="text-success" x-text="'Current: ' + formData.images.article_image"></small>
                        <small x-show="articleImageError" class="text-danger d-block mt-1" x-text="articleImageError"></small>
                    </div>
                    <div class="col-md-3 form-group">
                        <label>PDF Cover Image</label>
                        <input type="file" name="pdf_cover" class="form-control-file" accept="image/png, image/jpeg, image/jpg, image/gif, image/webp" @change="validatePdfCover($event)">
                        <small x-show="formData.images.pdf_cover_image" class="text-success" x-text="'Current: ' + formData.images.pdf_cover_image"></small>
                        <small x-show="pdfCoverError" class="text-danger d-block mt-1" x-text="pdfCoverError"></small>
                    </div>
                </div>

                <h6 class="section-header mt-4">Report Content (HTML Templates)</h6>
                <p class="small text-muted">Use [Company], [Ticker], [Price], [Chart], and [Current Date] as shortcodes.</p>

                <div class="form-group">
                    <label>Report Intro HTML</label>
                    <textarea name="report_intro_html" x-model="formData.content_templates.intro_html" class="form-control html-code-area" rows="4" placeholder="<p>Welcome to our daily stock analysis...</p>"></textarea>
                </div>

                <div class="form-group">
                    <label>Stock Block HTML</label>
                    <textarea name="stock_block_html" x-model="formData.content_templates.stock_block_html" class="form-control html-code-area" rows="6" placeholder="<div class='stock-card'><h3>[Company] ([Ticker])</h3><p>Price: [Price]</p><div>[Chart]</div></div>"></textarea>
                </div>

                <div class="form-group">
                    <label>Disclaimer HTML</label>
                    <textarea name="disclaimer_html" x-model="formData.content_templates.disclaimer_html" class="form-control html-code-area" rows="3" placeholder="<p><i>Disclaimer: Investment carries risk...</i></p>"></textarea>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary btn-block" :disabled="saving" x-text="saving ? 'Saving...' : (editingId ? 'Update Report Configuration' : 'Save Report Configuration')"></button>
                </div>
            </form>
        </div>
    </div>

    <div class="card mb-5" x-data="manualPdfUploader()">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center" style="cursor: pointer" @click="isOpen = !isOpen">
            <h5 class="mb-0">Manual PDF Override</h5>
            <span class="badge badge-dark">Upload PDF directly to /reports/</span>
        </div>
        <div class="card-body" x-show="isOpen" x-collapse>
            <p class="text-muted small">Upload a PDF file directly to the reports folder. This will overwrite any existing PDF with the same name.</p>
            <form @submit.prevent="uploadManualPdf" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label>PDF File Name (without extension)</label>
                        <input type="text" x-model="fileName" class="form-control" placeholder="e.g. 6AIStocks" required>
                        <small class="text-muted">The PDF will be saved as: <strong>[filename].pdf</strong></small>
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Select PDF File</label>
                        <input type="file" accept="application/pdf" class="form-control-file" required>
                        <small x-show="uploadError" class="text-danger d-block mt-1" x-text="uploadError"></small>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-warning btn-block" :disabled="uploading" x-text="uploading ? 'Uploading...' : 'Upload PDF to reports folder'"></button>
                </div>
            </form>
            <div x-show="uploadSuccess" x-transition class="alert alert-success mt-3" x-text="uploadSuccess"></div>
        </div>
    </div>

    <div class="card" x-data="configManager()">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Active Configurations</h5>
            <span class="badge badge-light">Stored in reportSettings.json</span>
        </div>
        <div class="card-body p-0">
            <div x-show="loading" class="text-center p-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <div x-show="!loading" x-transition>
                <table class="table table-hover mb-0">
                    <thead class="thead-light">
                    <tr>
                        <th>Filename</th>
                        <th>Title</th>
                        <th>Stocks</th>
                        <th class="action-btns">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <template x-for="config in configurations" :key="config.id">
                        <tr>
                            <td><strong x-text="config.file_name"></strong></td>
                            <td x-text="config.title"></td>
                            <td x-text="config.number_of_stocks"></td>
                            <td class="action-btns">
                                <button class="btn btn-sm btn-outline-info" @click="editConfig(config)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" @click="deleteConfig(config.id)">Delete</button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="configurations.length === 0">
                        <td colspan="4" class="text-center text-muted p-4">No configurations found. Create one above.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<footer class="text-center mt-5 mb-5 text-muted" x-data="{ systemDate: (() => { const d = new Date(); return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0') + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0') + ':' + String(d.getSeconds()).padStart(2, '0'); })() }">
    <hr>
    <small x-text="'System Date: ' + systemDate + ' | PHP 5.5 Compatibility Mode'"></small>
</footer>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="../public/js/api.js"></script>
</body>
</html>